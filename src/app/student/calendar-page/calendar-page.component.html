<div class="main-page">
  <div class="content-wrapper">
    <div class="content" >

      <div class="custom-today-header">
        <div class="today-header">
          {{ currentDate | date: 'd' }} {{ currentDate | date: 'MMMM' : 'kk' }}
        </div>
      </div>

      <div class="calendar-navigation">
        <button class="arrow-button left-arrow" (click)="previousWeek()">
          &#9664;
        </button>

        <div class="calendar-container">
          <ng-template #emptyHeaderTemplate>
            <div class="custom-header">
              <div *ngFor="let day of getWeekDays()"
                   class="custom-header-day"
                   [ngClass]="{'current-day': isToday(day)}">
                <div class="day-number">{{ day | date: 'd' }}</div>
                <div class="day-month">{{ day | date: 'MMMM' : 'kk' }}</div>
              </div>
            </div>
          </ng-template>

          <div class="calendar-week-view" *ngIf="events && events.length > 0">
            <mwl-calendar-week-view
              [hourSegmentHeight]="60"
              [hourSegments]="2"
              [viewDate]="viewDate"
              [events]="events"
              [locale]="'kk'"
              [weekStartsOn]="1"
              [headerTemplate]="emptyHeaderTemplate"
              [eventTemplate]="customEventTemplate"
              (beforeViewRender)="handleBeforeViewRender($event)">
            </mwl-calendar-week-view>
          </div>


          <ng-template #customEventTemplate let-weekEvent="weekEvent">
            <div *ngIf="weekEvent; else noEventTemplate" class="custom-event" (click)="onEventClicked(weekEvent.event)"
                 [ngStyle]="{
                 'border-color': weekEvent.event.color?.primary || '#6E63E5', 'color':weekEvent.event.color?.primary || '#6E63E5',
                 'background': 'linear-gradient(to bottom, ' + (weekEvent.event.color?.secondary || '#D4D0FF') + ' 0%, ' + (weekEvent.event.color?.secondary || '#D4D0FF') + ' 41%, #FFFFFF 100%)'
               }">
              <div class="event-title">
                <ng-container *ngFor="let line of (weekEvent.event.title || '').split('\n')">
                  <div class="title-line">{{ line }}</div>
                </ng-container>
                <div class="event-time">
                  {{ weekEvent.event.start ? (weekEvent.event.start | date: 'HH:mm') : 'No start time' }} -
                  {{ weekEvent.event.end ? (weekEvent.event.end | date: 'HH:mm') : 'No end time' }}
                </div>
              </div>
              <div>
                <ng-container *ngFor="let line of (weekEvent.event.subtitle || '').split('\n')">
                <div class="event-subject">{{ line }}</div>
                </ng-container>
              </div>
            </div>
            <ng-template #noEventTemplate>
              <div>No event data available (No event object)</div>
            </ng-template>
          </ng-template>



        </div>

        <button class="arrow-button right-arrow" (click)="nextWeek()">
          &#9654;
        </button>
      </div>


    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-calendar">
      <div class="month-calendar">

        <div class="custom-today-month-header">
          <div class="today-header">
            {{ currentDate | date: 'd' }} {{ currentDate | date: 'MMMM' : 'kk' }}
          </div>
          <div class="arrows">
            <div class="arrow" (click)="moveToPreviousMonth()">
              <img src="assets/images/arrow-left.svg" alt="left">
            </div>
            <div class="arrow" (click)="moveToNextMonth()">
              <img src="assets/images/arrow-right.svg" alt="right">
            </div>
          </div>
        </div>

        <ng-template #headerTemplate let-day="day">
          <div class="week-days-container">
            <div *ngFor="let day of getWeekDays()" class="week-day-header">
              <div class="day-letter">{{ day | date: 'EEEE' | slice:0:1 | uppercase }}</div>
            </div>
          </div>
        </ng-template>

         <mwl-calendar-month-view
          [viewDate]="viewDate"
          [events]="events"
          [weekStartsOn]="1"
          [headerTemplate]="headerTemplate"
          (dayClicked)="onDayClicked($event.day)"
        >
        </mwl-calendar-month-view>
      </div>
    </div>

    <div class="task-list">
      <!-- Today's Tasks Section -->
      <div *ngIf="todayTasks.length > 0 && !selectedTaskDetails && !isEventClicked">
        <h3>Сегодняшние задачи</h3>
        <div *ngFor="let event of todayTasks" class="task-item" [ngStyle]="{
          'border-color': event.color?.primary || '#6E63E5',
          'color': event.color?.primary || '#6E63E5',
          'background': 'linear-gradient(to bottom, '
                          + (event.color?.secondary || '#D4D0FF')
                          + ' 0%, '
                          + (event.color?.secondary || '#D4D0FF')
                          + ' 41%, #FFFFFF 100%)'
        }"
             (click)="fetchEventDetails(event.id, event.type, event.start)">
          <p>{{ event.title }}</p>
          <small>{{ event.start | date: 'HH:mm' }} - {{ event.end | date: 'HH:mm' }}</small>
        </div>
      </div>

      <!-- Selected Date Tasks Section -->
      <div *ngIf="selectedDateEvents.length > 0 && !selectedTaskDetails  && isEventClicked">
        <h3>Задачи на {{ selectedDateEvents[0]?.start | date: 'dd MMMM yyyy' }}</h3>
        <div *ngFor="let event of selectedDateEvents" class="task-item" [ngStyle]="{
          'border-color': event.color?.primary || '#6E63E5',
          'color': event.color?.primary || '#6E63E5',
          'background': 'linear-gradient(to bottom, '
                          + (event.color?.secondary || '#D4D0FF')
                          + ' 0%, '
                          + (event.color?.secondary || '#D4D0FF')
                          + ' 41%, #FFFFFF 100%)'
        }"
             (click)="onEventClicked(event)">
          <p>{{ event.title }}</p>
          <small>{{ event.start | date: 'HH:mm' }} - {{ event.end | date: 'HH:mm' }}</small>
        </div>
      </div>

      <div *ngIf="selectedDateEvents.length === 0 && !selectedTaskDetails && todayTasks.length===0">
        <p>Нет задач на выбранный день.</p>
      </div>
    </div>

    <div class="task-details" *ngIf="selectedTaskDetails">

      <button class="back-button" (click)="goBackToTaskList()">
        <img src="assets/images/arrow-left.svg" alt="left" class="back-icon"/>
        <h4 class="back-text">{{ selectedTaskDetails.type === 'homework' ? 'Үй жұмысы' : selectedTaskDetails.type === 'test' ? 'Тест' : '' }}</h4>
      </button>

      <div class="details-content">
        <div class="details-row">
          <span class="label">Пән:</span>
          <span class="value">{{ selectedTaskDetails.course_name }}</span>
        </div>

        <div class="details-row">
          <span class="label">Тақырып:</span>
          <span class="value">{{ selectedTaskDetails.topic_name }}</span>
        </div>

        <div class="details-row">
          <span class="label">Дедлайн:</span>
          <span class="value">{{ selectedTaskDetails.deadline | date: 'dd/MM/yyyy HH:mm' }}</span>
        </div>

        <div class="details-row" *ngIf="selectedTaskDetails.curator_name">
          <span class="label">Куратор:</span>
          <span class="value">{{ selectedTaskDetails.curator_name }}</span>
        </div>

        <div *ngIf="selectedTaskDetails.type === 'test'" class="details-row">
          <span class="label">Сұрақ саны:</span>
          <span class="value">{{ selectedTaskDetails.questions_count }}</span>
        </div>

        <div *ngIf="selectedTaskDetails.type === 'testant'" class="details-row">
          <span class="label">Куратор:</span>
          <span class="value">{{ selectedTaskDetails.proctor }}</span>
        </div>

        <div *ngIf="selectedTaskDetails.type === 'meet'" class="details-row">
          <button class="submit-button">
            Қослыу
          </button>
        </div>
      </div>

      <button class="submit-button" *ngIf="selectedTaskDetails.type === 'homework' || selectedTaskDetails.type === 'test'">
        Тапсыру
      </button>
    </div>



  </div>
</div>
